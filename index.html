<body>
    <div id="dashboard" class="dashboard">
        <h1>Live Border Wait Times</h1>
        
        <p id="loading">Loading data...</p>

    </div>
    
    <script>
        // The official CBP API URL is now used directly
        const apiUrl = 'https://bwt.cbp.gov/api/bwtRss/CSV/-1/57,55/57,55,106';
        const fetchUrl = apiUrl; // We are testing without a proxy

        const dashboard = document.getElementById('dashboard');
        const loadingMessage = document.getElementById('loading');

        function getStatusColor(waitTime) {
            const minutes = parseInt(waitTime);
            if (isNaN(minutes)) return '';
            if (minutes <= 20) return 'status-green';
            if (minutes <= 60) return 'status-yellow';
            return 'status-red';
        }

        fetch(fetchUrl)
            .then(response => response.ok ? response.text() : Promise.reject('Network response was not ok.'))
            .then(csvText => {
                const data = {};
                const rows = csvText.trim().split('\n');
                
                // Remove the first 4 rows of metadata from the CBP file
                for (let i = 0; i < 4; i++) {
                    rows.shift();
                }
                
                const headers = rows.shift().split(',');

                // --- THIS IS THE CORRECTED PART ---
                // Use the exact header names from the live data source
                const portIndex = headers.indexOf('Port Name');
                const laneIndex = headers.indexOf('Lane Name');
                // Check for both passenger and commercial vehicle wait time headers
                const passengerWaitIndex = headers.indexOf('Passenger Vehicle Lanes Wait Time');
                const commercialWaitIndex = headers.indexOf('Commercial Vehicle Lanes Wait Time');
                const updatedIndex = headers.indexOf('Date/Time');
                // --- END OF CORRECTION ---

                rows.forEach(rowText => {
                    const row = rowText.split(',');
                    const port = row[portIndex];
                    if (!data[port]) {
                        data[port] = [];
                    }

                    // Determine which wait time column to use
                    let waitTime = row[passengerWaitIndex] || row[commercialWaitIndex] || 'N/A';
                    
                    data[port].push({
                        lane: row[laneIndex],
                        waitTime: `${waitTime} min`,
                        lastUpdated: row[updatedIndex]
                    });
                });

                if(loadingMessage) loadingMessage.style.display = 'none';

                for (const portName in data) {
                    const lanes = data[portName];
                    let portHtml = `
                        <section class="port-section">
                            <h2 class="port-title">${portName}</h2>
                            <div class="card-container">`;
                    lanes.forEach(lane => {
                        const colorClass = getStatusColor(lane.waitTime);
                        portHtml += `
                            <div class="card ${colorClass}">
                                <h3>${lane.lane}</h3>
                                <div class="wait-time">${lane.waitTime}</div>
                                <div class="last-updated">Updated: ${lane.lastUpdated}</div>
                            </div>`;
                    });
                    portHtml += `</div></section>`;
                    dashboard.innerHTML += portHtml;
                }
            })
            .catch(error => {
                if(loadingMessage) loadingMessage.textContent = 'Failed to load data. This may be a CORS error. Check the console.';
                console.error('Fetch Error:', error);
            });
    </script>
</body>