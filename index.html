<body>
    <div id="dashboard" class="dashboard">
        <h1>Live Border Wait Times</h1>
        
        <p id="loading">Loading data...</p>

    </div>
    
    <script>
        const apiUrl = 'https://bwt.cbp.gov/api/bwtRss/CSV/-1/57,55/57,55,106';
        // Use the proxy for the live version, but you can comment it out for testing the CORS error
        const proxyUrl = 'https://api.allorigins.win/raw?url='; 
        const fetchUrl = proxyUrl + encodeURIComponent(apiUrl);
        //const fetchUrl = apiUrl; // We removed the proxy


        const dashboard = document.getElementById('dashboard');
        const loadingMessage = document.getElementById('loading');

        // ... getStatusColor function remains the same ...
        function getStatusColor(waitTime) {
            const minutes = parseInt(waitTime);
            if (isNaN(minutes)) return '';
            if (minutes <= 20) return 'status-green';
            if (minutes <= 60) return 'status-yellow';
            return 'status-red';
        }

        fetch(fetchUrl)
            .then(response => response.ok ? response.text() : Promise.reject('Network response was not ok.'))
            .then(csvText => {
                // --- LOGGING STEP 1: See the raw data from the API ---
                console.log("--- 1. Raw CSV Text Received ---");
                console.log(csvText);

                const data = {};
                const rows = csvText.trim().split('\n');
                
                for (let i = 0; i < 4; i++) {
                    rows.shift(); // Remove metadata
                }
                
                const headers = rows.shift().split(',');

                // --- LOGGING STEP 2: Check if the headers are what you expect ---
                console.log("--- 2. Parsed Headers ---");
                console.log(headers);

                const portIndex = headers.indexOf('Port Name');
                const laneIndex = headers.indexOf('Lane Name');
                const passengerWaitIndex = headers.indexOf('Passenger Vehicle Lanes Wait Time');
                const commercialWaitIndex = headers.indexOf('Commercial Vehicle Lanes Wait Time');
                const updatedIndex = headers.indexOf('Date/Time');

                // --- LOGGING STEP 3: See which column indexes were found ---
                // If any of these are -1, it means the header name is wrong.
                console.log("--- 3. Found Header Indexes ---");
                console.log({ portIndex, laneIndex, passengerWaitIndex, commercialWaitIndex, updatedIndex });

                rows.forEach((rowText, i) => {
                    const row = rowText.split(',');
                    
                    // --- LOGGING STEP 4: Look at the first row of data ---
                    if (i === 0) {
                        console.log("--- 4. First Data Row ---");
                        console.log(row);
                    }

                    const port = row[portIndex];
                    if (!port) return; // Skip if port name is missing

                    if (!data[port]) {
                        data[port] = [];
                    }

                    let waitTime = row[passengerWaitIndex] || row[commercialWaitIndex] || 'N/A';
                    
                    const laneData = {
                        lane: row[laneIndex],
                        waitTime: `${waitTime} min`,
                        lastUpdated: row[updatedIndex]
                    };

                    // --- LOGGING STEP 5: See the final object before it's used ---
                    if (i === 0) {
                        console.log("--- 5. First Parsed Lane Object ---");
                        console.log(laneData);
                    }

                    data[port].push(laneData);
                });

                if(loadingMessage) loadingMessage.style.display = 'none';

                // ... The HTML-building part remains the same ...
                for (const portName in data) {
                    const lanes = data[portName];
                    let portHtml = `
                        <section class="port-section">
                            <h2 class="port-title">${portName}</h2>
                            <div class="card-container">`;
                    lanes.forEach(lane => {
                        const colorClass = getStatusColor(lane.waitTime);
                        portHtml += `
                            <div class="card ${colorClass}">
                                <h3>${lane.lane}</h3>
                                <div class="wait-time">${lane.waitTime}</div>
                                <div class="last-updated">Updated: ${lane.lastUpdated}</div>
                            </div>`;
                    });
                    portHtml += `</div></section>`;
                    dashboard.innerHTML += portHtml;
                }
            })
            .catch(error => {
                if(loadingMessage) loadingMessage.textContent = 'Failed to load data. Check the console for errors.';
                console.error('Fetch Error:', error);
            });
    </script>
</body>